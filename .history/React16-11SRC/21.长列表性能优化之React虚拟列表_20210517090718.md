## 背景
在开发过程中，总是遇到很多列表的显示。当上数量级别的列表渲染于浏览器，终会导致浏览器的性能下降。如果数据量过大，首先渲染极慢，其次页面直接卡死。当然，你可以选择其他方式避免。例如分页，或者下载文件等等。我们这里讨论如果使用虚拟列表来解决这个问题。

## 什么是虚拟列表
最简单的描述：列表滚动时，变更`可视区域`内的渲染元素。<br>
![](./image/28.png)<br>

通过 `[单条数据预估高度]` 计算出 `[列表总高度]`和`[可视化区域高度 ]`。并在`[可视化区域高度]`内按需渲染列表。


## 相关概念简介
下面介绍在组件中，很重要的一些参数信息，这里先进行了解，有个印象，后续在使用的时候才比较明朗。

- `[单条数据预估高度]`： 列表中具体某一条列表的具体高度，它可以是 `[固定高度]`，也可以是`[动态高度]`
- `[列表总高度]`： 当所有数据渲染时，列表的`[总高度]`
- `[可视化区域高度]`: 挂在虚拟列表的容器。即列表可见的区域
- `[预估显示条数]`： 在 `[可视化区域高度]` 按照 `[单条数据预估高度]`，可见的数据条数
- `[开始索引]`: `[可视化区域高度]` 显示的数据的第一条数据的索引
- `[结束索引]`: `[可视化区域高度]` 显示的数据的最后一条数据的索引
- `[每条Item 位置缓存]`: 因为列表的高度不一定，因此会对每条数据的高度位置进行记录，包括 index索引，top, bottom, lineHeight属性

## 虚拟列表实现
虚拟列表可以简单理解为：当列表发生滚动时，变更`[可视化区域高度 ]`内的渲染元素，根据上面介绍的`相关概念`，我们依据这些属性，按照以下步骤进行：

- 传入组件数据 `[数据列表(resources)]` 和 `[预估高度（estimatedItemSize]`
- 根据 `[数据列表(resources)]`和 `[预估高度（estimatedItemSize]` 计算出每条数据的初始位置（当全部渲染时每条数据的占位）
- 计算出 `[列表总高度]`
- `[可视化区域高度]` 通过css控制
- 根据 `[可视化区域高度]`，计算出可视化区域预估显示条数
- 初始化可视窗口的 `[头挂载元素]`和`[尾挂载元素]`，当发生滚动时，根据滚动差值和滚动方向，重新计算`[头挂载元素]`和`[尾挂载元素]`。

依据以上的简介步骤，下面开始来实现一个虚拟列表吧。

### 驱动开发：参数剖析

| 参数              | 说明                 | 类型                     | 默认值                                                                                     |
| ----------------- | -------------------- | ------------------------ | ------------------------------------------------------------------------------------------ |
| resources         | 源数据数组           | Array                    | []                                                                                         |
| estimatedItemSize | 每条数据的预估高度   | number                   | 32px                                                                                       |
| extrea | 用于自定义ItemRender，传递其他参数 | any | none |
| ItemRender        | 每一条数据渲染的组件 | React.FC | `const ItemRender = ({ data }: Data) => (<React.Fragment>{String(data) }</React.Fragment>)` |
| key | 作为遍历时，生成item 的唯一key。需要是resources的数据具体的某个唯一值的字段。用于提高性能。| string | 默认顺序 自定义 -> id -> key -> index |

```javascript
import React, { useState } from 'react';
import { VirtualList } from 'biz-web-library';
// 定义每一条数据显示的组件
const ItemRender = ({ data }) => {
  let dindex = parseInt(data);
  let lineHeight = dindex % 2 ? '40px' : '80px';
  return (
    <div style={{ lineHeight, background: dindex % 2 ? '#f5f5f5' : '#fff' }}>
      <h3>#{dindex} title name</h3>
      <p>尽情地书写你想编写的内容，不局限于页面高度</p>
    </div>
  );
};
const ItemRenderMemo = React.memo(ItemRender);

// 初始化列表数据
const getDatas = () => {
  const datas = [];
  for (let i = 0; i < 100000; i++) {
    datas.push(`${i} Item`);
  }
  return datas;
};

// 使用虚拟列表
export default () => {
  let [resources, setResources] = useState([]);
  const changeResources = () => {
    setResources(getDatas());
  };

  return (
    <div>
      <button onClick={changeResources}>click me </button>

      <div
        style={{
          height: '400px',
          overflow: 'auto',
          border: '1px solid #f5f5f5',
          padding: '0 10px',
        }}
      >
        <VirtualList
          ItemRender={ItemRenderMemo}
          resources={resources}
          estimatedItemSize={60}
        />
      </div>
    </div>
  );
};
```
